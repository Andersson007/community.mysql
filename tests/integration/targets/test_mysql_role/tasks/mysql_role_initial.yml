# Test code for mysql_role module

- vars:
    mysql_parameters: &mysql_params
      login_user: '{{ mysql_user }}'
      login_password: '{{ mysql_password }}'
      login_host: 127.0.0.1
      login_port: '{{ mysql_primary_port }}'

    task_parameters: &task_params
      register: result

  block:

  - name: Get server version
    mysql_info:
      <<: *mysql_params
    register: srv

  - name: When run with unsupported server versions, must fail
    <<: *task_params
    mysql_role:
      <<: *mysql_params
      name: test
    ignore_errors: yes

  - name: Must fail when meet unsupported version
    assert:
      that:
      - result is failed
      - result is search('Roles are not supported by the server')
    when:
    - srv['version']['suffix'] == ''
    - srv['version']['major'] < 8

  - name: Must fail when meet unsupported version
    assert:
      that:
      - result is failed
      - result is search('Roles are not supported by the server')
    when:
    - srv['version']['suffix'] == 'MariaDB'
    - srv['version']['major'] < 10

  # Skip unsupported versions
  - meta: end_play
    when:
    - srv['version']['suffix'] == ''
    - srv['version']['major'] < 8

  - meta: end_play
    when:
    - srv['version']['suffix'] == 'MariaDB'
    - srv['version']['major'] < 10

  #########
  # Prepare
  - name: Create db {{ test_db }}
    <<: *task_params
    mysql_query:
      <<: *mysql_params
      query: 'CREATE DATABASE {{ test_db }}'
    register: result

  - name: Create table {{ test_table }}
    <<: *task_params
    mysql_query:
      <<: *mysql_params
      login_db: '{{ test_db }}'
      query: 'CREATE TABLE {{ test_table }} (id int)'
    register: result

  - name: Create user {{ user0 }}
    <<: *task_params
    mysql_user:
      <<: *mysql_params
      name: '{{ user0 }}'

  ###########
  # Run tests
  - name: Create role {{ role0 }}
    <<: *task_params
    mysql_role:
      <<: *mysql_params
      name: '{{ role0 }}'
      state: present
      members:
      - '{{ user0 }}'

  - name: Check
    assert:
      that:
      - result is changed

  - name: Create role {{ role0 }} again
    <<: *task_params
    mysql_role:
      <<: *mysql_params
      name: '{{ role0 }}'
      state: present

  - name: Check
    assert:
      that:
      - result is not changed

  always:
  # Clean up
  - name: Drop db {{ test_db }}
    mysql_query:
      <<: *mysql_params
      query: 'DROP DATABASE {{ test_db }}'
    register: result
